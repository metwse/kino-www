<script>
    const deck = root.querySelector("kino-deck");
    const done = root.querySelector(".done");

    var home = await window.session.home();
    var freeMode = false;
    var nextBusy = false

    deck.addCards(home.cards)
    next()

    const updateProgress = _ => {
        root.querySelector(".progress").innerText = `${home.done}/${home.total}`;
        let deckLevel = deck.card?.data?.deck?.level;
        root.querySelector(".deck-name").innerText =
            deckLevel !== undefined ? `deck ${deckLevel + 1}` : "all cards are done";

        if (home.done == home.total && !freeMode)
            done.style.display = "";
    }

    done.querySelector("button").onclick = async _ => {
        freeMode = true;
        home = await window.session.home(true);
        deck.addCards(home.cards);
        next();
        done.style.display = "none";
    }
    
    async function next(up) {
        if (nextBusy) return 
        nextBusy = true

        if (deck.card)
            deck.card.back.remove()

        var moveResponse = await deck.next(up, !freeMode);

        switch (moveResponse) {
            case "moved":
            case "kept":
                home.done += 1;
                break;
            case "removed":
                home.total -= 1;
                break;
        }

        if (deck.cardCount == 1) {
            home = await window.session.home(freeMode);
            deck.addCards(home.cards);
            nextBusy = false
        }

        await updateProgress()

        nextBusy = false
    }

    var startX = 0;
    var movement = 0;
    deck.ontouchstart = ({ changedTouches: [touch] }) => {
        startX = touch.screenX;
    }

    deck.ontouchmove = async ({ changedTouches: [touch] }) => {
        movement = touch.screenX - startX;
        if (Math.abs(movement) > 10) {
            if (movement > 0) movement -= 10;
            else movement += 10;
            if (deck.card)
                deck.card.style.transform = `translateX(${movement}px)`
            if (Math.abs(movement) >= 54) next(movement > 0)
        }
    }

    deck.ontouchend = async _ => {
        if (Math.abs(movement) < 54) {
            deck.card.style.transform = `translateX(0)`
            setTimeout(_ => deck.card.flip(), 1)
        }
        else next(movement > 0)
        movement = 0
    }

    window.onkeydown = async ({ key }) => {
        if (["ArrowRight", "d"].includes(key)) {
            next(true)
        }
        if (["ArrowLeft", "a"].includes(key)) {
            next(false)
        }
    }

    if (window.ontouchstart === undefined) {
        deck.onclick = _ => {
            setTimeout(_ => deck.card.flip(), 1)
        }
    }
</script>

<nav>
    <span class="progress">n/m</span>
    <span class="deck-name">deck 1</span>
</nav>
<div class="main">
    <kino-deck class="deck"></kino-deck>
    <div class="done" style="display: none;">
        <span>Recurring cards are done.</span>
        <button>practice freely</button>
    </div>
</div>


<style>
    :host {
        display: flex;
        padding: 0 !important;
        flex-direction: column;
    }

    nav {
        display: flex;
        padding: 1em 2em 0;
        justify-content: space-between;
    }

    .main { 
        display: grid; 
        padding: 1em;
        flex-grow: 1; 
    }

    .main > * {
        grid-area: 1 / 1 / 2 / 2
    }

    .done {
        display: flex;
        flex-direction: column;
        justify-content: center; align-items: center;
        gap: 1em;
        z-index: 2;

        span { font-size: 1.25em; }
    }
</style>
